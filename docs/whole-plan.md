# Dream of One — 디자인 설계서 v6.2 (이벤트 중심·지속 세션·로컬 LLM 최적화) 

> **핵심 문장**: 목표 지향 조직들 사이에서 **꿈 밖에서 온 티**를 내지 않고 살아간다. 규범을 읽고, 맡은 **역할(Cover)** 을 수행하며, 실수를 **사회적으로 수습**해 의심을 낮춘다. **판정은 규칙과 증거(Artifact)가 결정**하고, LLM은 **1줄 대사·요약**만 담당한다.

---

## 0) 문서 목적(읽는 법)
**게임 설계**를 먼저 완결하고, 이어서 **Unity 구현 개요·성능 예산·개발 조직 운영안**을 제시한다. 코드와 프롬프트 세부는 별도 구현 명세로 분리한다.

---

## 1) 초록(Abstract) & 연구 목적(Study Aim)
**게임 요약**: 70m×70m 블록(인디 스튜디오, 편의점, 공원, 지구대)에서 플레이어는 **가십(잡담/소문)** 과 **증거물(Artifacts)** 을 읽고 만들어가며 규범을 해독하고 생존한다. NPC는 목표 지향적으로 행동하고, 모든 결과는 **텍스트 1–2줄 + 성과물**로 남는다. **세션 제한은 없다(지속 세션).**

**연구/사회실험 각도**: 치안·릴리즈·모더레이션 정책을 바꿔 **가십 전파/확정 지연, 전역 인지율 G, 준수율**의 변화를 계측한다. **LLM 지연**은 세계 내부의 **검토·예열·편성(Diegetic Delay)** 로 표현한다.

---

## 2) 용어(Glossary)
- **WEL(World Event Log)**: 콜라이더/인벤토리/타이머/대화 등 **모든 사실 변화의 Append-only 로그**. **목적은 NPC의 환경 파악과 지표·디버깅용 맥락 제공**이며, **로그 재생으로 상태를 복원하지 않는다**(세이브/로드는 별도 스냅샷 방식).
- **Semantic Shaper**: WEL의 저수준 이벤트 묶음을 **사람이 읽는 1줄 문장**으로 결정 규칙에 따라 승격.
- **Spatial Blackboard**: **존/오브젝트별 최근 1줄 요약 버퍼**(최근 N개). NPC는 근접·시야 조건에서 읽는다.
- **Generator / Referee**: LLM **생성기**(1줄 초안)와 **심사기**(규범·어휘 검수, 근거 요약)를 분리.
- **o(outsiderness)**: 대화 1건에 대한 ‘외부인스러움’ 점수 ∈[0,1].
- **pᵢ(belief)**: NPC i가 플레이어를 외부인이라 믿는 확률. 대화·관찰로 갱신.
- **RC(Release Candidate)**: 빌드 카트리지(보라색). PM 승인 후 서버 슬롯 투입 시 제출.
- **Artifact**: 루머/고발/해명/승인 노트, CCTV 캡처, 칸반 로그, 위반 티켓 등 **눈에 보이는 증거**.
- **G(전역 인지율)**: 사회가 플레이어의 ‘외부성/위반’을 알아채는 정도. **G≥0.30**이면 **페널티 상태**(검문 증가·대기 연장)로 전환.
- **분석 윈도우 W**: 지표 산출용 롤링 시간창(기본 8–12분). **게임플레이 제약이 아님**.
- **Economy(최소형)**: **일급**(세션 지속·퇴출 미발생 시 지급) + **과태료**(티켓·신고 즉시 공제).

---


## 3) 하이컨셉 & 기둥(Pillars)
1) **텍스트-우선**: 모든 상호작용은 **1–2줄 + 성과물**로 귀결.
2) **결정적 코어·AI 표면화**: 판정·전이·지표는 결정적, LLM은 **문장 변주·요약**에 한정.
3) **가십 생태계**: **공유→질문→확정/반박**이 순환하며 정보가 스스로 흐른다.
4) **디에제틱 LLM**: 느림은 **검토/예열/편성**으로 위장되어 리듬이 된다.
5) **지속 세션**: 중단 없이 이어지고, 저장/복원으로 연속성 보장.
6) **행동 나열 금지, 관찰 우선**: ‘액션 12종’ 나열 대신 **WEL→Blackboard→NPC 관찰** 구조가 주축.

---

## 4) 월드·조직·NPC
### 4.1 장소
- **인디 스튜디오(2층)**: 칸반 보드, 라운지, 서버 슬롯
- **편의점**: 카운터, 진열/라벨
- **공원**: 벤치 8, 게시판 2
- **지구대 초소**: 프린터, 캡처 보드
- **CCTV×2**: 로비 교차(사각 1)

### 4.2 조직 목표
- **스튜디오**: RC 제출(승인→투입)
- **지구대**: 경범 1건 처리/재발 방지, 캡처 보강
- **상인회**: 라벨 갱신, 품절 0 유지
- **공원관리**: 좌석/소음 규범 유지

### 4.3 NPC 로스터(12명)
| ID | 역할 | 이름 | 루틴 요약 |
|---|---|---|---|
| P1 | 경찰 | Alpha | 초소↔로비 순찰, 캡처/티켓 |
| P2 | 경찰 | Bravo | 공원↔편의점 순찰, 중재 |
| T1 | 도둑 | Luca | 공원 정찰→로비→RC 시도 |
| D1 | 개발자 | Mina | 데스크→칸반→RC 준비 |
| PM1 | PM | Jun | 라운지→패치노트→승인 |
| C1 | 점원 | Yuri | 카운터 상주, 라벨 갱신 |
| J1 | 미화 | Han | 공원/로비 점검, 조치 보고 |
| CZ1 | 시민 | Elder | 벤치 상주, 양보 이벤트 |
| CZ2 | 시민 | Office | 편의→로비, 잡담 |
| CZ3 | 시민 | Student | 공원→스튜디오 앞, 잡담 |
| CZ4 | 시민 | Blogger | 촬영 시도, 게시판 루머 |
| CZ5 | 시민 | Tourist | CCTV 근처 질문, 가십 확산 |

---

## 5) 규칙(세션 활성 6–8개, 텍스트 판정)
- **R1 왼손 인사**: 오른손 인사 시 경고 텍스트
- **R2 좌측 보행**: 역주행 시 근접 주의 텍스트
- **R4 순서 합의**: 합의 없이 새치기 텍스트 포착 시 위반
- **R5 벤치 우선**: 노년 양보/비양보 텍스트로 판정
- **R10 촬영/기록 제한**: 무분별 촬영 텍스트 시 위반
- **R11 증거물 방해 금지**: 카트리지/캡처/티켓 훼손 텍스트 위반
- **R12 신고 의무(60초)**: 목격 후 신고 텍스트 없으면 미신고

---

## 6) 세계 이벤트 체계(액션 나열 제거)
### 6.1 이벤트 분류(일부)
`EnteredZone / ExitedZone / QueuedAtCounter / Spoke(utterance_id) / LabelChanged(sku,from→to) / EvidenceTouched(id) / ReportFiled / CCTVCaptured(actor) / RumorShared / RumorQuestioned / RumorConfirmed / RumorDebunked / ApprovalGranted / RCInserted`

### 6.2 Event→Text(Semantic Shaper)
- 저수준 이벤트 묶음을 **결정 규칙**으로 1줄 문장으로 승격.
- 예) `QueuedAtCounter(etiquette=violated)` → “새치기 의심: 말로 순서 합의 없음.”
- LLM은 **문장 톤 변주만** 수행(판정·상태 전이는 규칙 기반).

### 6.3 Spatial Blackboard(존/오브젝트 흑판)
- 각 존이 **최근 N=10줄** 텍스트 버퍼 보유. TTL=6–10분.
- NPC는 근접/시야 조건에서 해당 블랙보드를 읽어 **o, pᵢ**를 갱신하고 발화 선택.

---

## 7) 대화 판단 파이프라인(Generator↔Referee)
- **입력**: (역할, 현재 목표, 관련 블랙보드 요약, 금칙어)
- **Generator**: 1줄 초안 생성(캐시·쿨다운 적용)
- **Referee**: 규범/어휘 검수, **o∈[0,1]** 산출, 근거 1줄 요약
- **출력**: 최종 1줄 + (옵션) 근거 토큰 축약 기록

### 7.1 평판 전파·신고·심문
- 개인 신념 **pᵢ**는 대화/가시 이벤트로 갱신(가중 이동 평균).
- 근접자에게 간단한 **루머 전파 모델**로 전이. 특정 임계 도달 시 **신고** 이벤트 발생.
- 경찰은 **사건 묶음**(증거·반박·절차 준수)을 검토해 **퇴출/보류/무혐의** 판정.

---

## 8) 가십 네트워크(요약)
- **토픽**: `{RC, 새치기, 좌석, 촬영, 훼손, 검문…}` + `place/time/actor`
- **메모리**: NPC별 최근 N=5(신뢰 w∈[0,1], 출처, 시각), TTL=8분
- **전파**: 근접 2인, 쿨다운 30초, `w_new = clamp(0.7·w_src + 0.3·w_self)`
- **확정/반박**: 증거(A5/A13/A16) 근접 시 `w±`, **회색→컬러** 전환/해명 생성

---

## 9) 탐지·의심(결정적 수치)
- **감지**: FOV 110°, 거리 8m, 근접 1.2m, 소음 6m
- **개인 의심 sᵢ ∈ [0,100]**: 위반/왜곡 가십(+) ↔ 해명/중재/확정 증거(–)
- **임계**: sᵢ≥35(경고), ≥60(티켓). 임계 시 **페널티 상태**(검사 주기↑, 대기↑)
- **전역 G ∈ [0,1]**: sᵢ 가중 평균(경찰/PM 가중 1.3). **G≥0.30**이면 대응 레벨 상승

---

## 10) 성과물(12종·색상 규약)
A1 RC 카트리지(보라, 소멸형), A2 칸반 로그, A3 패치노트(초록), A5 CCTV 캡처(지연), A6 위반 티켓(파랑), A7 가격·품절 라벨, **A12 루머 카드(회색→컬러)**, A13 고발 메모, A14 해명 메모, A15 조치 보고, A16 승인 노트, A17 사건 로그 스트립

- **상태**: `Draft(회색) → Final(컬러)` 전환. Final만 G 감소/승인 요건 반영
- **TTL**: 기본 6분(라벨/태그), 10분(승인/문서)

---

## 11) UI/HUD
- **상단 HUD**: 개인 의심바, 전역 G
- **노트 패널**: 규칙 가설 3칸(증거 슬롯)
- **토스트**: 모든 문장은 1–2줄(80자 규격)
- **게시판**: 루머/고발/해명 카드(회색→컬러)

---

## 12) 정책 팩 & 지표(실험 가능성)
- **팩 P(치안 강화)**: 경고 임계–5, 검사 주기↓, CCTV 예열–5s, 위반 가중×1.2
- **팩 S(릴리즈 우선)**: 승인 대기–20%, 과업 완료의 s 감소량 +2, 라벨 엄격도↑

**핵심 지표(W 기준)**: Violation Rate, Rumor Confirmation Delay, Distortion Rate, G Curve, RC Lead Time, **Outsider Impressions per Conversation(평균 o)**, **Report Time(최초 의심→신고)**

---

## 13) 지속 세션(세이브/리셋 없이 굴러가게)
- **상태 스냅샷 저장/복원**: 규칙 가설, 카드 상태, sᵢ, G, 라벨 등 **현재 상태를 주기적 JSON 스냅샷**으로 저장·로드한다. **WEL은 복원에 사용하지 않는다**(분석·컨텍스트 전용).
- **이벤트 캐던스**: 분당 0.6–1.2건 자연 발생, 피크 10건/분
- **엔트로피 주입**: 라벨 누락, 잘못된 호칭, 라인 붕괴 같은 경미 사건 큐
- **Economy(최소형)**: 실제 시간 경과 + 퇴출 미발생 시 **일급 지급**. 티켓·신고는 **즉시 공제**

---


## 14) Unity 구현 개요(액션 없이 가능한가)
**핵심 라인**: **WEL → Semantic Shaper → Spatial Blackboard → NPC(Behavior Graph) → (필요 시) LLM**

- **WEL**: `EventBus(ScriptableObject)` + `AppendOnlyStore(JSONL)` (분석/컨텍스트 전용)
- **pub/sub**: **DI SignalBus**(Zenject/VContainer)로 토픽·스코프 단위 라우팅
- **Blackboard/Behavior**: Unity **Behavior Graph + 공유 Blackboard**. **이벤트 트리거형 노드**(Event/Conditional/Wait)만 사용해 부분 실행
- **LLM**: **Generator/Referee** 이중화, 실패 시 **템플릿 폴백**. **근접 LOD**, **쿨다운(90/120s)**, **배치(5s/K≤3)**
- **CCTV**: `Camera+RenderTexture(256–512)` → 프린트 프리팹(예열 20–30s)
- **Nav**: AI Navigation 2.x, Agent 12체 제한, 런타임 재베이크 금지

### 14.5) 로컬 LLM 런타임 계획(제한된 VRAM 대응)
> **목표**: 단일 PC·소형 GPU에서도 안정적으로 1줄 변주/요약을 제공. **판정·상태 전이는 100% 규칙 기반**으로 유지해 LLM 불가 시에도 게임이 완전 동작.

**A. 모델/정밀도 티어**
- **6–8GB VRAM**: 7B 계열 **Q4(혹은 Q4_K)** 양자화, 컨텍스트 ≤ 900토큰, 동시 1스트림
- **10–12GB VRAM**: 7B **Q5** 또는 13B **Q4**, 동시 1–2스트림
- **16GB+ VRAM**: 13B **Q5** 권장, 동시 2스트림 가능

**B. 스케줄링/예산**
- **글로벌 토큰 예산**: 분당 **≤ 1k–1.5k 토큰**(씬 전체)
- **배치 큐**: 5초마다 최대 K≤3 실행, **우선순위=심문/신고>거래/중재>잡담**
- **쿨다운**: 동일 NPC 90s, 동일 토픽 120s, 캐시 히트 시 호출 생략

**C. 컨텍스트 압축**
- **Blackboard Slimming**: 존당 10줄 유지, **요약 길이 80자 이하**, 불용 문구 제거
- **슬롯 스키마**: `(역할, 현재목표, 토픽, 최근증거3, 금칙어)` 만 주입
- **출력 구문 제한**: 1줄/80자, 금칙어/톤 가드(Referee 규칙)

**D. 캐시/폴백**
- **세만틱 캐시 키**: `hash(역할+토픽+요약N줄)`
- **L0 템플릿 모드**: LLM 장애 시 **역할별 고정 템플릿**으로 즉시 대체
- **L1 Generator-only**: Referee 비활성(규칙 검수만)으로 지연 완화

**E. 호스트 구성**
- **로컬 러너**: 경량 서버(예: llama.cpp/ggml/gguf 호환) HTTP/pipe, **동시성 1–2**
- **스레드/CPU 보조**: 토큰 생성은 GPU, **요약/정규화는 CPU 스레드**로 분리
- **I/O**: 논블로킹 호출 + 타임아웃(≤1.5s) + 재시도 1회

**F. 품질 가드**
- **금칙어/어휘 표준**: 역할별 용어집, 존별 금칙어 리스트
- **Determinism**: `temperature≤0.5`, `top_p≤0.9`, 길이 하드컷

---


## 15) 성능 예산(가드레일)
- **이벤트량**: 2–4건/분(평시), **피크 10건/분**
- **Blackboard**: 존당 최근 10줄, **컨텍스트 ≤ 900토큰**(2존 기준)
- **Behavior CPU**: **< 0.3 ms**(에디터), GC.Alloc **0B/프레임**
- **SignalBus 디스패치**: **< 0.05 ms/이벤트**, 단일 인스턴스 보장
- **LLM 호출율(로컬)**: **평균 ≤ 4회/분(전체)**, 피크 6회/분, **P95 지연 ≤ 1.5 s**
- **LLM 토큰 예산(로컬)**: **≤ 1k–1.5k 토큰/분(씬 전체)**
- **RT 해상도**: 256–512px, 출력 후 텍스처 즉시 해제

---


## 16) 부하 테스트 계획(파일럿 5일)
- **D1–D2(이벤트·Behavior)**: 합성 이벤트 10건/분×3존, NPC 12. 목표: Behavior **<0.3 ms**, GC 0B
- **D3(pub/sub)**: 분당 600 신호 브로드캐스트. 목표: 디스패치 **<0.05 ms**, GC 0B, 다중 버스 검출 테스트
- **D4(LLM 스텁/배치)**: 피크 6회/분, 배치 5s/K≤3. 목표: 프레임 변동 **<0.5 ms**
- **D4-Extra(로컬 VRAM 드릴)**: 6–8GB/10–12GB/16GB+ 프로파일별 **토큰 예산·지연** 측정, **L0/L1 디그레이드 모드** 전환 검증
- **D5(통합)**: 실제 씬+RT+Nav 12체. 목표: **60분 연속** 드랍·GC 스파이크 없음

---


## 17) 개발 조직(Program Development Organization)
### 17.1 구조(2인 코어 + 링 팀)
- **게임 디렉터/시스템**: 규칙·지표·이벤트 캐던스(최종 승인)
- **클라이언트/툴**: Unity 구현, UI/HUD, Addressables, Profiler, 빌드 파이프라인
- **링 팀**: LLM 브로커(프롬프트 가드·캐시·템플릿), 텍스트 에디트, 사운드/아트

### 17.2 워킹 방식
- **주간 스프린트**: 월 목표 합의, 금 플레이테스트
- **산출물**: GDD 변경 로그, KPI 스냅샷 그래프, **JSONL 플레이 로그**
- **RACI/DoD**: 
  1) 모든 흐름이 **WEL→Shaper→Blackboard**로 귀결, 
  2) 문장 80자 이하, 
  3) Addressables·Profiler·GC 0B 체크 통과, 
  4) KPI 3종 이상 보고

### 17.3 저장소·브랜치·릴리즈
- 브랜치: `main`/`dev`/`feat/*`/`fix/*`
- PR 규칙: 한 PR=한 기능. 체크리스트: 성과물 스폰, 토스트, SuspicionΔ 로그, Addressables 등록
- 릴리즈 태그: `v6.1.x-evented`. 태그 시 자동 빌드(+리포트 PDF)

### 17.4 로그 스키마(JSONL)
```
{t, actor, event, role, pos, topic?, rule?, o?, p_i?, s, G,
 llm:{tool:"generator|referee", latency_ms, cache_hit},
 artifact:{id?, state?}, note}
```

---

## 18) KPI & 완료 기준(Continuous)
- **Violation Rate(W)** ≤ 0.20
- **Rumor Confirmation Delay** 중앙값 ≤ 120초
- **RC Lead Time** 중앙값 ≤ 6분
- **Outsider Impressions**(평균 o) ≤ 0.35
- **Detection Escalation 빈도(W)** ≤ 2회
> 위 5개 중 4개 이상 + **60분 연속** 플레이에서 성능 가드 통과 시 **프로토타입 완료**

---

## 19) 리스크 & 대응
- **LLM 변덕/지연/VRAM 부족**: 캐시, 타임아웃, 템플릿 폴백(L0), Generator-only(L1), 모델 티어 다운스케일(7B Q4→Q3), 토큰 예산 캡
- **가독성 붕괴**: 규범은 **표지/유니폼/라인**으로 예고, 모든 문장 1–2줄 유지
- **엔트로피 고갈**: 사건 큐·토픽 풀 유지, 노이즈 NPC(블로거/투어리스트) 주입
- **성능 병목**: NavMesh 재베이크 금지, RT 해제 즉시화, Agent 12체 제한, **SignalBus 단일 인스턴스 보장**
- **데이터 부풀림**: WEL은 분석·컨텍스트 전용, **스냅샷 세이브만** 사용(로그 재생 금지)

---

## 20) 부록
### 20.1 이벤트 키(샘플)
`LabelChanged / PaymentProcessed / CleanTagPlaced / StampApproved / CCTVCaptured / RumorShared / RumorConfirmed / RumorDebunked / ReportFiled / RCInserted`

### 20.2 토스트 템플릿(80자 규격, 일부)
- 경고: "여긴 직원 구역입니다. 표지 뒤쪽 라인까지 물러나 주세요."
- 사과: "제가 순서를 놓쳤네요. 먼저 오신 분부터 도와드릴게요."
- 승인: "검수가 끝났습니다. 스탬프 찍어 드릴게요."

### 20.3 G 업데이트 의사코드
```// 15초마다
G += clamp( violations*0.01 - finals*0.008, -0.02, +0.04 );
G = clamp(G, 0, 1);
```

